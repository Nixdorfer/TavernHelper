mod commands;
mod database;
mod services;
mod types;

use tauri::Manager;

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_dialog::init())
        .plugin(tauri_plugin_clipboard_manager::init())
        .plugin(tauri_plugin_fs::init())
        .plugin(tauri_plugin_shell::init())
        .setup(|app| {
            let app_data_dir = app.path().app_data_dir().expect("Failed to get app data dir");
            std::fs::create_dir_all(&app_data_dir).expect("Failed to create app data dir");
            database::init_db(&app_data_dir).expect("Failed to initialize database");
            #[cfg(debug_assertions)]
            {
                if let Some(window) = app.get_webview_window("main") {
                    window.open_devtools();
                }
            }
            Ok(())
        })
        .invoke_handler(tauri::generate_handler![
            commands::config::load_config,
            commands::config::save_config,
            commands::config::update_config,
            commands::config::load_session_state,
            commands::config::save_session_state,
            commands::project::get_projects,
            commands::project::load_project_by_name,
            commands::project::save_project,
            commands::project::delete_project,
            commands::project::rename_project,
            commands::project::create_project,
            commands::project::update_project_current_node,
            commands::project::load_project,
            commands::project::update_project_time,
            commands::node::create_child_node,
            commands::node::create_brother_node,
            commands::node::rename_node,
            commands::node::update_node_note,
            commands::node::update_node_desc,
            commands::node::delete_node,
            commands::node::get_node_path,
            commands::node::rebase_node,
            commands::node::get_branch_tag,
            commands::node::set_branch_tag,
            commands::node::delete_branch_tag,
            commands::node::update_node_by_id,
            commands::node::update_node,
            commands::node::generate_line_serial,
            commands::worldtree::get_node_content,
            commands::worldtree::add_folder,
            commands::worldtree::add_folder_with_parent,
            commands::worldtree::add_card,
            commands::worldtree::add_block,
            commands::worldtree::add_line,
            commands::worldtree::update_line_content,
            commands::worldtree::update_card_key_word,
            commands::worldtree::update_card_triggers,
            commands::worldtree::update_block_title,
            commands::worldtree::delete_folder,
            commands::worldtree::delete_card,
            commands::worldtree::delete_block,
            commands::worldtree::delete_line,
            commands::worldtree::get_node_detail,
            commands::worldtree::immediate_change,
            commands::worldtree::save_node_changes,
            commands::worldtree::get_system_folder_change_ids,
            commands::worldtree::compute_effective_content,
            commands::worldtree::compute_sync_dot_status,
            commands::worldtree::add_line_marker,
            commands::worldtree::remove_line_marker,
            commands::worldtree::delete_line_in_node,
            commands::worldtree::add_line_in_node,
            commands::worldtree::get_node_line_markers,
            commands::worldtree::compute_node_inherited_content_items,
            commands::worldtree::compute_node_effective_content_items,
            commands::worldtree::compute_node_delta,
            commands::worldtree::apply_delta,
            commands::worldtree::get_node_with_delta,
            commands::worldtree::reconstruct_node_from_delta,
            commands::worldtree::add_line_numbers_to_world_book,
            commands::gallery::get_gallery_images,
            commands::gallery::get_gallery_folders,
            commands::gallery::create_gallery_folder,
            commands::gallery::delete_gallery_folder,
            commands::gallery::delete_gallery_image,
            commands::gallery::delete_gallery_images,
            commands::gallery::move_gallery_image_to_folder,
            commands::gallery::read_gallery_image_as_base64,
            commands::gallery::select_and_add_gallery_image,
            commands::gallery::select_and_add_to_folder,
            commands::gallery::add_gallery_image_from_base64,
            commands::gallery::add_gallery_image_from_base64_to_folder,
            commands::gallery::rename_gallery_image,
            commands::gallery::rename_gallery_folder,
            commands::gallery::update_gallery_image_url,
            commands::drafts::get_all_drafts,
            commands::drafts::create_draft,
            commands::drafts::update_draft,
            commands::drafts::delete_draft,
            commands::drafts::get_clipboard_captures,
            commands::drafts::move_clipboard_to_draft,
            commands::drafts::start_clipboard_monitor,
            commands::drafts::stop_clipboard_monitor,
            commands::drafts::clear_all_clipboard_captures,
            commands::drafts::copy_to_clipboard,
            commands::auth::auth_login,
            commands::auth::auth_get_profile,
            commands::auth::auth_logout,
            commands::auth::auth_get_points,
            commands::conversation::get_conversations,
            commands::conversation::get_conversation_detail,
            commands::conversation::delete_conversation,
            commands::conversation::rename_conversation,
            commands::conversation::create_new_conversation,
            commands::local_data::get_apps,
            commands::local_data::create_app,
            commands::local_data::delete_app,
            commands::local_data::rename_app,
            commands::local_data::get_local_conversations,
            commands::local_data::create_local_conversation,
            commands::local_data::delete_local_conversation,
            commands::local_data::rename_local_conversation,
            commands::local_data::set_conversation_node,
            commands::local_data::get_conversation_node,
            commands::local_data::get_dialogues,
            commands::local_data::create_dialogue,
            commands::local_data::update_dialogue,
            commands::local_data::delete_dialogue,
            commands::local_data::add_dialogue_image,
            commands::local_data::get_dialogue_images,
            commands::creation::get_local_creations,
            commands::creation::get_local_creation_config,
            commands::creation::get_local_creation_by_remote_id,
            commands::creation::save_local_creation,
            commands::creation::rename_local_creation,
            commands::creation::delete_local_creation,
            commands::creation::save_local_creation_page,
            commands::creation::get_local_creation_page,
            commands::creation::create_new_local_creation,
            commands::creation::fetch_with_auth,
            commands::creation::get_app_info,
            commands::creation::get_user_app_model_config,
            commands::creation::export_user_app_model_config,
            commands::creation::update_user_app_model_config,
            commands::creation::upload_creation_image,
            commands::creation::upload_gallery_image_to_remote,
            commands::creation::save_creation_app_cache,
            commands::creation::get_creation_app_cache,
            commands::creation::get_all_creation_app_cache,
            commands::creation::delete_creation_app_cache,
            commands::creation::generate_image_byte_dance,
            commands::creation::send_test_chat,
            commands::system::hide_window,
            commands::system::show_window,
            commands::system::is_debug_mode,
            commands::system::open_file_dialog,
            commands::system::save_file_dialog,
            commands::system::get_safe_mode_txt_files,
            commands::system::read_safe_mode_template,
            commands::system::read_prompt_file,
            commands::system::write_prompt_file,
            commands::system::is_caps_lock_on,
            commands::crypto::generate_encryption_key_pair,
            services::dirty_manager::get_dirty_state,
            services::dirty_manager::set_original_content,
            services::dirty_manager::update_current_content,
            services::dirty_manager::mark_content_saved,
            services::dirty_manager::is_content_dirty,
            services::dirty_manager::has_any_dirty_content,
            services::dirty_manager::get_all_dirty_states,
            services::dirty_manager::clear_dirty_item,
            commands::temp_manager::get_temp_dir_path,
            commands::temp_manager::save_temp_file,
            commands::temp_manager::load_temp_file,
            commands::temp_manager::delete_temp_file,
            commands::temp_manager::list_temp_files,
            commands::temp_manager::cleanup_temp_files,
            commands::temp_manager::get_unsaved_sessions,
            commands::temp_manager::recover_temp_session,
            commands::temp_manager::discard_temp_session,
            commands::temp_manager::discard_all_temp_sessions,
            commands::temp_manager::save_creation_temp,
            commands::temp_manager::save_world_tree_temp,
            commands::temp_manager::clear_creation_temp,
            commands::temp_manager::clear_world_tree_temp,
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
